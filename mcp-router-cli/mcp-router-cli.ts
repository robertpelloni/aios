#!/usr/bin/env node

import { Command } from 'commander';
import { MCPRegistryService, type RegistryServerDefinition } from '@aios/core/services/MCPRegistryService.js';
import { ServerRegistryService, type ServerInstallationResult } from '@aios/core/services/ServerRegistryService.js';
import { ConfigurationService } from '@aios/core/services/ConfigurationService.js';
import { McpSessionService } from '@aios/core/services/McpSessionService.js';

const program = new Command();

program
    .name('aios-mcp-router')
    .description('Ultimate MCP Router - Manage MCP servers, configurations, and sessions')
    .version('1.0.0')
    .option('--data-dir <path>', 'Data directory path', './data')
    .option('--format <type>', 'Output format (json, table)', 'json');

const dataDir = program.opts().dataDir || './data';

console.log('Initializing borg MCP Router...');
console.log(`Data directory: ${dataDir}`);

const registry = MCPRegistryService.getInstance(dataDir);
const serverRegistry = ServerRegistryService.getInstance(dataDir);
const configService = ConfigurationService.getInstance(dataDir);
const sessionService = McpSessionService.getInstance(dataDir);

program
    .command('discover')
    .description('Discover servers from all registries')
    .action(async () => {
        console.log('Discovering servers from registries...');
        const servers = await registry.discoverAll();
        console.log(`Discovered ${servers.length} servers from ${registry.getStats().categories.length} categories`);
    });

program
    .command('search <query>')
    .description('Search discovered servers')
    .action(async (options, command) => {
        const query = command.args[0] || '';
        console.log(`Searching for: ${query}`);
        const results = registry.searchServers(query);
        console.log(`Found ${results.length} servers`);
        if (program.opts().format === 'table') {
            console.table(results.map((r: RegistryServerDefinition) => ({
                Name: r.name,
                Category: r.category,
                Rating: r.rating || '-',
                Installed: r.installed ? 'Yes' : 'No',
                Source: r.source
            })));
        } else {
            console.log(JSON.stringify(results, null, 2));
        }
    });

program
    .command('categories')
    .description('List all available categories')
    .action(async () => {
        const categories = registry.getCategories();
        console.log('Available categories:');
        categories.forEach(cat => console.log(`  - ${cat}`));
    });

program
    .command('stats')
    .description('Get registry statistics')
    .action(async () => {
        const stats = registry.getStats();
        console.log('Registry Statistics:');
        console.log(`  Total servers: ${stats.totalServers}`);
        console.log(`  Installed: ${stats.installedServers}`);
        console.log(`  Categories: ${stats.categories.length}`);
        console.log(`  Last sync: ${new Date(stats.lastSync).toISOString()}`);
    });

program
    .command('install <name>')
    .description('Install a server from registry')
    .action(async (options, command) => {
        const name = command.args[0];
        console.log(`Installing server: ${name}`);
        const result = await serverRegistry.installServer(name, {
            type: 'github',
            autoStart: true
        });

        if (result.success) {
            console.log(`Installed successfully: ${result.serverId}`);
            await sessionService.startSession(result.serverId!);
            sessionService.setAutoStart(result.serverId!, true);
        } else {
            console.error(`Installation failed: ${result.error}`);
            process.exit(1);
        }
    });

program
    .command('uninstall <serverId>')
    .description('Uninstall a server')
    .action(async (options, command) => {
        const serverId = command.args[0];
        console.log(`Uninstalling server: ${serverId}`);
        const success = await serverRegistry.uninstallServer(serverId);

        if (success) {
            console.log('Uninstalled successfully');
        } else {
            console.error('Uninstallation failed');
            process.exit(1);
        }
    });

program
    .command('check-updates')
    .description('Check for server updates')
    .action(async () => {
        console.log('Checking for updates...');
        const updates = await serverRegistry.checkUpdates();
        const withUpdates = updates.filter((u: any) => u.hasUpdates);
        console.log(`Checked ${updates.length} servers, ${withUpdates.length} have updates`);
        if (program.opts().format === 'table') {
            console.table(withUpdates.map((u: any) => ({
                Server: u.serverName,
                Status: u.hasUpdates ? 'Update Available' : 'Up to Date',
                Latest: u.commitHash || '-'
            })));
        }
    });

program
    .command('update <serverId>')
    .description('Update a specific server')
    .action(async (options, command) => {
        const serverId = command.args[0];
        console.log(`Updating server: ${serverId}`);
        const result = await serverRegistry.updateServer(serverId);

        if (result.success) {
            console.log('Updated successfully');
        } else {
            console.error(`Update failed: ${result.error}`);
            process.exit(1);
        }
    });

program
    .command('health <serverId>')
    .description('Check server health')
    .action(async (options, command) => {
        const serverId = command.args[0];
        console.log(`Checking health: ${serverId}`);
        const health = await serverRegistry.checkServerHealth(serverId);

        console.log(`Status: ${health.status}`);
        if (health.latencyMs !== undefined) {
            console.log(`Latency: ${health.latencyMs}ms`);
        }
        if (health.error) {
            console.log(`Error: ${health.error}`);
        }
    });

program
    .command('detect-configs')
    .description('Auto-detect MCP configurations')
    .action(async () => {
        console.log('Auto-detecting configurations...');
        const configs = await configService.detectConfigs();
        console.log(`Detected ${configs.length} configuration files`);
        if (program.opts().format === 'table') {
            console.table(configs.map((c: any) => ({
                File: c.path,
                Format: c.format,
                Servers: c.servers.length
            })));
        } else {
            console.log(JSON.stringify(configs, null, 2));
        }
    });

program
    .command('import-configs <files...>')
    .description('Import MCP configurations')
    .action(async (options, command) => {
        const files = command.args;
        console.log(`Importing ${files.length} configurations...`);
        const result = await configService.importConfigs(files);

        if (result.success) {
            console.log(`Imported ${result.imported} servers successfully`);
        } else {
            console.error(`Import failed: ${result.errors.length} errors`);
            result.errors.forEach((err: string) => console.log(`  - ${err}`));
        }
    });

program
    .command('export-configs <format>')
    .description('Export configurations')
    .option('--format <type>', 'Export format (aios, claude, openai, google)', 'aios')
    .action(async (options, command) => {
        const format = program.opts().format || 'aios';
        console.log(`Exporting to ${format} format...`);

        try {
            const content = await configService.exportConfigs(format);
            console.log('Export successful');
            console.log(content);
        } catch (e: any) {
            console.error(`Export failed: ${e.message}`);
            process.exit(1);
        }
    });

program
    .command('init-sessions')
    .description('Initialize session service')
    .action(async () => {
        console.log('Initializing session service...');
        await sessionService.initialize();

        const stats = sessionService.getStats();
        console.log(`Initialized ${stats.totalSessions} sessions`);
        console.log(`Running: ${stats.running}`);
        console.log(`Total clients: ${stats.totalClients}`);
    });

program
    .command('session-stats')
    .description('Get session statistics')
    .action(async () => {
        const stats = sessionService.getSessionStats();
        console.log('Session Statistics:');
        console.log(`  Total sessions: ${stats.totalSessions}`);
        console.log(`  Running: ${stats.running}`);
        console.log(`  Stopped: ${stats.stopped}`);
        console.log(`  Error: ${stats.error}`);
        console.log(`  Total clients: ${stats.totalClients}`);
    });

program
    .command('list-sessions')
    .description('List all sessions')
    .action(async () => {
        const sessions = sessionService.getAllSessions();

        if (program.opts().format === 'table') {
            console.table(sessions.map((s: any) => ({
                ID: s.sessionId.substring(0, 20),
                Name: s.serverName,
                Status: s.status,
                Clients: s.clients.length,
                AutoRestart: s.autoRestart ? 'Yes' : 'No'
            })));
        } else {
            console.log(JSON.stringify(sessions, null, 2));
        }
    });

program
    .command('start-session <serverId>')
    .description('Start a server session')
    .action(async (options, command) => {
        const serverId = command.args[0];
        console.log(`Starting session: ${serverId}`);
        await sessionService.startSession(serverId);
        console.log('Session started');
    });

program
    .command('stop-session <serverId>')
    .description('Stop a server session')
    .action(async (options, command) => {
        const serverId = command.args[0];
        console.log(`Stopping session: ${serverId}`);
        const session = sessionService.stopSession(serverId);

        if (session) {
            console.log('Session stopped');
        } else {
            console.error('Session not found');
            process.exit(1);
        }
    });

program
    .command('restart-session <serverId>')
    .description('Restart a server session')
    .action(async (options, command) => {
        const serverId = command.args[0];
        console.log(`Restarting session: ${serverId}`);
        await sessionService.stopSession(serverId);
        await sessionService.startSession(serverId);
        console.log('Session restarted');
    });

program
    .command('shutdown-sessions')
    .description('Shutdown all sessions')
    .action(async () => {
        console.log('Shutting down all sessions...');
        await sessionService.shutdown();
        console.log('All sessions shut down');
    });

program.parseAsync().then(async () => {
    console.log('Ultimate MCP Router ready!');
    console.log('');
    console.log('Available commands:');
    console.log('  Registry Management:');
    console.log('    discover       - Discover servers from registries');
    console.log('    search         - Search discovered servers');
    console.log('    categories      - List all categories');
    console.log('    stats           - Get registry statistics');
    console.log('');
    console.log('  Server Management:');
    console.log('    install         - Install server from registry');
    console.log('    uninstall       - Uninstall server');
    console.log('    check-updates   - Check for updates');
    console.log('    update          - Update a server');
    console.log('    health          - Check server health');
    console.log('');
    console.log('  Configuration Management:');
    console.log('    detect-configs  - Auto-detect configurations');
    console.log('    import-configs   - Import configurations');
    console.log('    export-configs   - Export configurations');
    console.log('');
    console.log('  Session Management:');
    console.log('    init-sessions    - Initialize session service');
    console.log('    session-stats    - Get session statistics');
    console.log('    list-sessions    - List all sessions');
    console.log('    start-session    - Start a server session');
    console.log('    stop-session     - Stop a server session');
    console.log('    restart-session   - Restart a server session');
    console.log('    shutdown-sessions - Shutdown all sessions');
    console.log('');
    console.log('Examples:');
    console.log('  aios-mcp-router discover                  - Discover all servers');
    console.log('  aios-mcp-router search "file system"       - Search for file servers');
    console.log('  aios-mcp-router install fs-server           - Install filesystem server');
    console.log('  aios-mcp-router init-sessions               - Auto-start all servers');
    console.log('  aios-mcp-router session-stats              - Get session statistics');
}).catch(err => {
    console.error('Error:', err.message);
    process.exit(1);
});
